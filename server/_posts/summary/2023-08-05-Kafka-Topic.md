---
layout: post  
title:  Kafka Topic 과 Partition
description:  
date: 2023-08-05 15:00 PM  
categories: summary
---

## Kafka Topic 과 Partition

카프카를 사용하는 것은 토픽을 만들면서 시작되고, 토픽을 삭제하면 데이터가 삭제되고 파이프라인은 중단됩니다.
이렇게 토픽은 카프카의 중요한 역할을 하기 때문에 토픽에 대해서 자세히 알고 잘 활용하는 것이 중요하다 생각이 들어,
토픽에 관련된 정보를 정리하고자 합니다.

### 파티션

파티션의 개수는 카프카의 성능과 관련이 있습니다. 그렇기에 토픽의 적절한 파티션 개수를 설정하고 운영하는 것이 매우 중요합니다.
파티션의 개수를 정하는 데에 고려해야 할 점은 3가지가 있습니다.

- 데이터 처리량
- 메시지 키 사용 여부
- 브로커, 컨슈머 영향도


#### 데이터 처리량
파티션은 카프카의 병렬처리의 핵심입니다. 파티션의 개수가 증가할수록 1:1 매핑되는 컨슈머 개수가 늘어나기 때문입니다.

- `Producer 전송 데이터량 < 컨슈머 데이터 처리량 * 파티션 개수`

예를 들어 프로듀서가 초당 1,000 레코드를 전송하고 컨슈머가 초당 100개의 레코드를 처리할 수 있다면 필요한 파티션 개수는 10개입니다.
만약 그렇지 못한다면 컨슈머 랙이 생기고, 데이터 처리 지연이 발생하게 됩니다.

데이터 지연이 절대로 발생하면 안되는 서비스의 경우 프로듀서의 데이터 최대치를 데이터 생성량으로 잡고 계산해야 하지만,
데이터의 지연이 일부 발생해도 괜찮다면 그러지 않아도 됩니다.

하지만 파티션의 개수를 늘리게 된다면 컨슈머, 브로커의 부담이 증가하기 때문에 무조건 늘리는 것만이 좋은것은 아닙니다.

#### 메시지 키 사용 여부

메시지 키를 사용하면 프로듀서가 토픽으로 데이터를 보낼 때 메시지 키를 파티션에 매칭시킵니다. 
하지만 파티션 개수가 달라지게 된다면, 이미 매칭된 파티션과 메시지 키의 매칭이 깨지게 되고 다른 파티션에 데이터가 할당됩니다.

그렇기 때문에 메시지 키를 사용하고 컨슈머에서 메시지 처리 순서가 보장되어야 한다면 최대한 파티션의 변화가 발생하지 않는 방향으로 운영해야합니다.
만약 파티션 개수가 변해야 한다면 메시지 키 매칭을 그대로 가져가기 위하여 커스텀 파티셔너를 개발하고 적용해야 합니다.

#### 브로커와 컨슈머의 영향도

파티션은 각 브로커의 파일 시스템을 사용하기 때문에 파티션이 늘어나는 만큼 브로커에서 접근하는 파일 개수가 많아집니다.
하지만 운영체제에서는 프로세스당 열 수 있는 파일 개수를 제한하고 있기 때문에 안정적인 운영을 위하여, 각 브로커당 파티션 개수를 모니터링 해야합니다.

파티션의 개수가 너무 많다면 파티션 개수를 분산하기 위해서 카프카 브로커 개수를 늘리는 방안도 같이 고려해야 합니다.